from ROOT import TCanvas, TGraphErrors, TF1, Math, TLegend
from ROOT import gROOT
from array import array
import pandas
import sys
import numpy as np
 
c1 = TCanvas( 'c1', 'LED Pulser Calibration', 200, 10, 700, 500 )
c1.cd() 
c1.SetGrid()
c1.GetFrame().SetFillColor( 21 )
c1.GetFrame().SetBorderSize( 12 )

#get data from file
cols = ["run","V","hg_mpv","hg_mpverr"]
df = pandas.read_csv("led_calib.csv", names=cols,index_col=False,header=None,sep=',')
df=df.sort_values(by="run",ascending = True)
df = df.reset_index()
n = df.shape[0]
V = []
hg_mpv = []
Verr = n*[0]
hg_mpverr = []
#fill arrays with data from dataframe
for i in range(n):
    scale_factor = 1
    if int(df.loc[i,"run"]) >= 1589:
        scale_factor = (379.7/1633.2)
        if int(df.loc[i,"run"]) >= 1599:
            scale_factor = scale_factor*(321.2/1318.9)
            if int(df.loc[i,"run"]) >=1604:
                scale_factor = scale_factor*(318.8/633.4)
    V.append(df.loc[i,"V"])
    hg_mpv.append(df.loc[i,"hg_mpv"]*scale_factor)
    hg_mpverr.append(df.loc[i,"hg_mpverr"]*scale_factor)

legend = TLegend(0.7,0.65,0.85,0.85)
#new dataframe and file to save calibration
df2 = pandas.DataFrame(data=np.transpose([V,hg_mpv,hg_mpverr]),columns=["V","rel_mpv","mpv_err"])
df2.to_csv(path_or_buf="ledinitcalib.csv",header=False,index=False)

gr = TGraphErrors(len(V), array('f',V), array('f',hg_mpv),array('f',Verr), array('f',hg_mpverr))
gr.SetTitle("10 ns LED Pulser Calibration; Function Generator Voltage (V); Relative Intensity (Arbitrary Scale)")
gr.SetMarkerColor(4)
gr.SetMarkerStyle( 21 )
#gr.GetXaxis().SetLimits(42.1,42.4) 
#gr[ch].GetXaxis().SetLimits(40.0,40.5)
#gr[ch].GetYaxis().SetRangeUser(390,410)
#gr.Draw( 'ALP' )
#fitting
#f[ch].SetParameters(2,0.1,25)
#f[ch].SetLineColor(ch+2)
#Math.MinimizerOptions.SetDefaultMinimizer("Minuit2")
#result[ch] = gr[ch].Fit("parab"+str(ch),"SQR")
#legend.AddEntry(f[ch],"Ch. "+str(ch),"l")
#result[ch].Print()
gr.Draw("AP")
#f[ch].Draw("same")
'''
if len(sys.argv)>1:
    m = float(sys.argv[1])
    f0 = TF1("f","[0]",40,42.5)
    f0.SetParameter(0,m)
    f0.Draw("same")
    f0.SetLineColor(1)
legend.Draw("same")
'''
c1.Update()
c1.SaveAs("ledcalibration.pdf")
c1.SaveAs("ledcalibration.png")
        
